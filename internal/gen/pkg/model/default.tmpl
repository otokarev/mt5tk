package {{.Name}}

// !!!WARNING!!! It is a autogenerated file!

import (
	"encoding/json"
	"github.com/google/go-querystring/query"
	"github.com/otokarev/mt5tk/pkg/client"
	"github.com/otokarev/mt5tk/pkg/connection"
	"github.com/otokarev/mt5tk/pkg/model/entities"
	"log"
	"strconv"
)

type {{.Type}} struct {
	Client     *client.Client
	ClientPool []*client.Client
}

type getRequest struct {
	Id string `url:"{{.IdName}}"`
}

type getResponse struct {
	Answer entities.{{.Type}} `json:"answer"`
}

type totalResponse struct {
	Answer struct {
		Total string `json:"total"`
	} `json:"answer"`
}

func (g *{{.Type}}) GetTotal() (int, error) {
	payload, err := g.Client.Get("/api/{{.Name}}/total")
	if err != nil {
		return 0, err
	}
	resp := totalResponse{}
	if nil != json.Unmarshal(payload, &resp) {
		return 0, err
	}
	total, err := strconv.Atoi(resp.Answer.Total)
	if nil != err {
		return 0, err
	}

	return total, nil
}

func (g *{{.Type}}) Add(data entities.{{.Type}}) (entities.{{.Type}}, error) {
	body, err := json.Marshal(data)
	if err != nil {
		return entities.{{.Type}}{}, err
	}
	resultBytes, err := g.Client.Post("/api/{{.Name}}/add", body)
	if err != nil {
		return entities.{{.Type}}{}, err
	}

	var result entities.{{.Type}}
	err = json.Unmarshal(resultBytes, &result)
	if err != nil {
		return entities.{{.Type}}{}, err
	}

	return result, err
}

func (g *{{.Type}}) Exists(name string) (bool, error) {
	_, err := g.Get(name)
	if err == nil {
		return true, nil
	}

	if cerr, ok := err.(*connection.Error); ok == true && cerr.IsNotFound() == false {
		log.Fatalf("cannot verify {{.Name}} %s existance, error: %s", name, err.Error())
		return false, cerr
	}

	return false, nil
}

func (g *{{.Type}}) Get(name string) (entities.{{.Type}}, error) {
	req := getRequest{Id: name}
	q, err := query.Values(req)
	if err != nil {
		return entities.{{.Type}}{}, err
	}

	payload, err := g.Client.Get("{{.GetPath}}?" + q.Encode())
	if err != nil {
		return entities.{{.Type}}{}, err
	}
	resp := getResponse{}
	if nil != json.Unmarshal(payload, &resp) {
		return entities.{{.Type}}{}, err
	}

	return resp.Answer, nil
}
